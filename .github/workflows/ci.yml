name: ci
on:
  pull_request:
  push:
    branches: [main]
permissions:
  contents: read
  pull-requests: read
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true
jobs:
  ci:
    name: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate markdown exists
        run: |
          set -euo pipefail
          if find . -name "*.md" -print -quit | grep -q .; then
            echo "OK: markdown found"
          else
            echo "FAIL: no markdown found"
            exit 1
          fi
      - name: Detect Node project
        id: node
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            echo "has_node=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_node=false" >> "$GITHUB_OUTPUT"
          fi
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            echo "has_npm_lock=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_npm_lock=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Enforce lockfile when Node exists
        if: steps.node.outputs.has_node == 'true' && steps.node.outputs.has_npm_lock != 'true'
        run: |
          echo "package.json detected but no npm lockfile found."
          echo "Add package-lock.json (recommended) or npm-shrinkwrap.json."
          exit 1
      - uses: actions/setup-node@v4
        if: steps.node.outputs.has_node == 'true' && steps.node.outputs.has_npm_lock == 'true'
        with:
          node-version: 20
          cache: npm
      - name: Install
        if: steps.node.outputs.has_node == 'true' && steps.node.outputs.has_npm_lock == 'true'
        run: npm ci
      - name: Lint
        if: steps.node.outputs.has_node == 'true' && steps.node.outputs.has_npm_lock == 'true'
        run: npm run lint --if-present
      - name: Typecheck
        if: steps.node.outputs.has_node == 'true' && steps.node.outputs.has_npm_lock == 'true'
        run: npm run typecheck --if-present
      - name: Test
        if: steps.node.outputs.has_node == 'true' && steps.node.outputs.has_npm_lock == 'true'
        run: npm test --if-present
      - name: Build
        if: steps.node.outputs.has_node == 'true' && steps.node.outputs.has_npm_lock == 'true'
        run: npm run build
        env:
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}

  codex-review:
    name: codex-review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check for Codex thumbs-up
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            
            const CODEX_USERNAME = 'chatgpt-codex-connector';
            
            const reactions = await github.rest.reactions.listForIssue({
              owner,
              repo,
              issue_number: prNumber,
            });
            
            const codexThumbsUp = reactions.data.find(
              r => r.user.login === CODEX_USERNAME && r.content === '+1'
            );
            
            if (codexThumbsUp) {
              console.log(`‚úÖ ${CODEX_USERNAME} has approved this PR`);
            } else {
              core.setFailed(`‚ùå Waiting for ${CODEX_USERNAME} to approve with üëç`);
            }