---
phase: 04-authentication---admin-panel
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/projects.ts
  - convex/resume.ts
  - convex/changelog.ts
  - convex/contactSubmissions.ts
autonomous: true

must_haves:
  truths:
    - "All admin mutations verify authentication before executing"
    - "Unauthenticated requests to admin mutations throw 'Unauthorized' error"
    - "Non-admin authenticated users cannot execute admin mutations"
  artifacts:
    - path: "convex/projects.ts"
      provides: "Admin CRUD mutations for projects"
      exports: ["listAll", "create", "update", "remove", "updateStatus", "updateFeatured"]
      min_lines: 120
    - path: "convex/resume.ts"
      provides: "Admin update mutation for resume"
      exports: ["update"]
      min_lines: 30
    - path: "convex/changelog.ts"
      provides: "Admin queries and mutations for changelog"
      exports: ["listAll", "updateVisibility"]
      min_lines: 40
    - path: "convex/contactSubmissions.ts"
      provides: "Admin query and mutations for contact submissions"
      exports: ["listAll", "updateStatus"]
      min_lines: 40
  key_links:
    - from: "convex/projects.ts"
      to: "ctx.auth.getUserIdentity()"
      via: "Authentication verification in every mutation"
      pattern: "ctx\\.auth\\.getUserIdentity\\(\\)"
    - from: "convex/resume.ts"
      to: "ctx.auth.getUserIdentity()"
      via: "Authentication verification in update mutation"
      pattern: "ctx\\.auth\\.getUserIdentity\\(\\)"
    - from: "convex/changelog.ts"
      to: "ctx.auth.getUserIdentity()"
      via: "Authentication verification in mutations"
      pattern: "ctx\\.auth\\.getUserIdentity\\(\\)"
---

<objective>
Create authenticated Convex mutations for all admin operations (projects, resume, changelog, contact submissions) with defense-in-depth verification.

Purpose: Establish data access layer security. Every admin mutation verifies authentication at the data boundary, protecting against middleware bypass (CVE-2025-29927). Complements middleware protection for robust security.

Output: Complete set of admin CRUD operations with auth verification, enabling admin panel forms to safely mutate data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-authentication---admin-panel/04-RESEARCH.md

# Current backend
@convex/schema.ts
@convex/projects.ts
@convex/resume.ts
</context>

<tasks>

<task type="auto">
  <name>Add admin mutations to projects.ts</name>
  <files>convex/projects.ts</files>
  <action>
    Add authenticated admin mutations to convex/projects.ts (keep existing public queries):

    1. Import mutation, query from convex server and v from convex/values

    2. Add listAll query (admin-only - returns ALL projects including drafts):
       - Verify ctx.auth.getUserIdentity() exists, throw "Unauthorized" if not
       - Return ctx.db.query("projects").collect()

    3. Add create mutation:
       - Args: title, slug, summary, content, status, featured, stack, tags, links, screenshots (match schema exactly)
       - Verify auth with ctx.auth.getUserIdentity(), throw "Unauthorized" if not
       - Insert into projects table
       - Return new project ID

    4. Add update mutation:
       - Args: id (v.id("projects")), plus optional fields (title, slug, summary, content, status, featured, stack, tags, links, screenshots)
       - Verify auth, throw "Unauthorized" if not
       - Use ctx.db.patch(id, updates)

    5. Add remove mutation:
       - Args: id (v.id("projects"))
       - Verify auth, throw "Unauthorized" if not
       - Use ctx.db.delete(id)

    6. Add updateStatus mutation (quick toggle):
       - Args: id (v.id("projects")), status (v.union(v.literal("draft"), v.literal("published")))
       - Verify auth, throw "Unauthorized" if not
       - Patch status field only

    7. Add updateFeatured mutation (quick toggle):
       - Args: id (v.id("projects")), featured (v.boolean())
       - Verify auth, throw "Unauthorized" if not
       - Patch featured field only

    Reference: 04-RESEARCH.md "Authentication Verification in Convex Mutations" for auth verification pattern.
    Important: Every mutation MUST call ctx.auth.getUserIdentity() and throw if null.
  </action>
  <verify>
    1. Check convex/projects.ts exports 6 new functions: listAll, create, update, remove, updateStatus, updateFeatured
    2. Check each mutation has auth verification: const identity = await ctx.auth.getUserIdentity(); if (!identity) throw...
    3. Run: npm run typecheck
    4. Verify no type errors in projects.ts
  </verify>
  <done>
    Projects table has complete admin CRUD with authentication verification. All mutations throw "Unauthorized" if not authenticated.
  </done>
</task>

<task type="auto">
  <name>Add admin mutation to resume.ts</name>
  <files>convex/resume.ts</files>
  <action>
    Add authenticated update mutation to convex/resume.ts (keep existing get query):

    1. Import mutation from convex server and v from convex/values

    2. Add update mutation:
       - Args: highlights (v.array(v.string())), experience (v.array with full nested structure), education (v.array), skills (v.array)
       - Match schema structure exactly from convex/schema.ts
       - Verify auth with ctx.auth.getUserIdentity(), throw "Unauthorized" if not
       - Check if resume document exists with ctx.db.query("resume").first()
       - If exists: ctx.db.patch(existingId, args)
       - If not exists: ctx.db.insert("resume", args)
       - Return document ID

    Pattern: Single-document table with upsert behavior.
    Reference: 04-RESEARCH.md for auth verification pattern.
  </action>
  <verify>
    1. Check convex/resume.ts exports update mutation
    2. Check update mutation has auth verification
    3. Check upsert logic (patch if exists, insert if not)
    4. Run: npm run typecheck
  </verify>
  <done>
    Resume table has admin update mutation with authentication verification. Supports both creating and updating the single resume document.
  </done>
</task>

<task type="auto">
  <name>Add admin operations to changelog.ts and contactSubmissions.ts</name>
  <files>convex/changelog.ts, convex/contactSubmissions.ts</files>
  <action>
    Create new Convex function files for changelog and contact submissions admin operations:

    1. Create convex/changelog.ts:
       - Import query, mutation from convex server and v from convex/values
       - Add listAll query (admin-only):
         * Verify auth, throw "Unauthorized" if not
         * Return ctx.db.query("changelog").withIndex("by_date").order("desc").collect()
       - Add updateVisibility mutation:
         * Args: id (v.id("changelog")), visible (v.boolean())
         * Verify auth, throw "Unauthorized" if not
         * Patch visible field

    2. Create convex/contactSubmissions.ts:
       - Import query, mutation from convex server and v from convex/values
       - Add listAll query (admin-only):
         * Verify auth, throw "Unauthorized" if not
         * Return ctx.db.query("contactSubmissions").withIndex("by_status").collect()
       - Add updateStatus mutation:
         * Args: id (v.id("contactSubmissions")), status (v.union(v.literal("new"), v.literal("archived")))
         * Verify auth, throw "Unauthorized" if not
         * Patch status field

    Pattern: Both files follow same structure - admin query returning all records, mutation for toggling status field.
  </action>
  <verify>
    1. Check convex/changelog.ts exists and exports listAll, updateVisibility
    2. Check convex/contactSubmissions.ts exists and exports listAll, updateStatus
    3. Check both files have auth verification in all mutations
    4. Run: npm run typecheck
    5. Run: npm run build
  </verify>
  <done>
    Changelog and contact submissions have admin queries and mutations with authentication verification. Admin can view all entries and toggle visibility/status.
  </done>
</task>

</tasks>

<verification>
1. All admin mutations verify authentication with ctx.auth.getUserIdentity()
2. All mutations throw "Unauthorized" if identity is null
3. Projects has 6 admin operations: listAll, create, update, remove, updateStatus, updateFeatured
4. Resume has 1 admin operation: update (with upsert logic)
5. Changelog has 2 admin operations: listAll, updateVisibility
6. ContactSubmissions has 2 admin operations: listAll, updateStatus
7. npm run build completes without errors
</verification>

<success_criteria>
- ADMIN-11: All Convex mutations verify auth context before executing âœ“
- Data layer security established for:
  - Projects CRUD (create, read, update, delete)
  - Resume updates
  - Changelog visibility toggles
  - Contact submission status management
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication---admin-panel/04-02-SUMMARY.md` documenting:
- Admin mutations created for projects (6 operations)
- Admin mutations created for resume (1 operation with upsert)
- Admin mutations created for changelog (2 operations)
- Admin mutations created for contact submissions (2 operations)
- All mutations include authentication verification
- Defense-in-depth security: middleware + mutations both verify auth
</output>
