---
phase: 04-authentication---admin-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - middleware.ts
  - app/auth/callback/route.ts
  - app/auth/sign-in/route.ts
  - app/auth/sign-out/route.ts
  - app/ConvexClientProvider.tsx
  - convex/auth.config.ts
  - .env.local
autonomous: false

user_setup:
  - service: workos
    why: "Authentication provider for admin-only access"
    env_vars:
      - name: WORKOS_CLIENT_ID
        source: "WorkOS Dashboard -> API Keys -> Client ID"
      - name: WORKOS_API_KEY
        source: "WorkOS Dashboard -> API Keys -> Secret Key"
      - name: WORKOS_COOKIE_PASSWORD
        source: "Generate locally: openssl rand -base64 32"
      - name: NEXT_PUBLIC_WORKOS_REDIRECT_URI
        source: "Set to http://localhost:3000/auth/callback for dev"
      - name: ADMIN_EMAIL
        source: "Your admin email address"
    dashboard_config:
      - task: "Configure JWT custom claims template"
        location: "WorkOS Dashboard -> Authentication -> Configure JWT Template"
        details: "Add email allowlist logic: {% if user.email | lower in [\"your@email.com\"] %}true{% else %}false{% endif %}"

must_haves:
  truths:
    - "Unauthenticated users are redirected to sign-in when accessing /admin/*"
    - "Only allowlisted email can successfully authenticate"
    - "Authenticated user session persists across browser refresh"
    - "Sign-out clears session and redirects to home"
  artifacts:
    - path: "middleware.ts"
      provides: "Route protection for /admin/* paths"
      min_lines: 15
    - path: "app/auth/callback/route.ts"
      provides: "OAuth callback handler"
      exports: ["GET"]
    - path: "app/auth/sign-in/route.ts"
      provides: "Sign-in redirect handler"
      exports: ["GET"]
    - path: "app/auth/sign-out/route.ts"
      provides: "Sign-out handler"
      exports: ["GET"]
    - path: "app/ConvexClientProvider.tsx"
      provides: "Auth-wrapped Convex provider"
      contains: "ConvexProviderWithAuth"
    - path: "convex/auth.config.ts"
      provides: "WorkOS JWT validation config"
      contains: "workos"
  key_links:
    - from: "middleware.ts"
      to: "@workos-inc/authkit-nextjs"
      via: "authkitMiddleware wrapper"
      pattern: "authkitMiddleware"
    - from: "app/ConvexClientProvider.tsx"
      to: "convex/react"
      via: "ConvexProviderWithAuth + useAuth"
      pattern: "ConvexProviderWithAuth.*useAuth"
    - from: "convex/auth.config.ts"
      to: "WORKOS_CLIENT_ID"
      via: "JWT issuer and JWKS configuration"
      pattern: "process\\.env\\.WORKOS_CLIENT_ID"
---

<objective>
Integrate WorkOS AuthKit with Next.js and Convex for secure admin authentication with email allowlist enforcement.

Purpose: Establish authentication foundation that protects all admin routes and enables authenticated Convex mutations. Follows defense-in-depth: middleware (UX), layout checks (UI), and mutation verification (security boundary).

Output: Working authentication flow with sign-in, sign-out, session persistence, and email allowlist validation via JWT custom claims.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-authentication---admin-panel/04-RESEARCH.md

# Prior phase outputs
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

# Current codebase
@convex/schema.ts
@app/layout.tsx
@app/ConvexClientProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Install WorkOS packages and configure authentication</name>
  <files>package.json, .env.local, convex/auth.config.ts</files>
  <action>
    1. Install WorkOS and Convex integration packages:
       - Run: npm install @workos-inc/authkit-nextjs @convex-dev/workos

    2. Create convex/auth.config.ts following WorkOS-Convex integration pattern:
       - Import WORKOS_CLIENT_ID from environment
       - Configure two JWT providers (customJwt type):
         * Issuer 1: "https://api.workos.com/" with algorithm RS256
         * Issuer 2: "https://api.workos.com/user_management/${clientId}" with algorithm RS256
       - Both use JWKS URL: https://api.workos.com/sso/jwks/${clientId}
       - Reference: 04-RESEARCH.md "WorkOS AuthKit + Convex Integration Setup"

    3. Add placeholder environment variables to .env.local:
       WORKOS_CLIENT_ID=client_placeholder
       WORKOS_API_KEY=sk_placeholder
       WORKOS_COOKIE_PASSWORD=placeholder_32_chars
       NEXT_PUBLIC_WORKOS_REDIRECT_URI=http://localhost:3000/auth/callback
       NEXT_PUBLIC_CONVEX_URL=(already exists)
       ADMIN_EMAIL=placeholder@example.com

    Note: User will replace placeholders with real values from WorkOS dashboard after account setup.
  </action>
  <verify>
    1. Check package.json includes @workos-inc/authkit-nextjs and @convex-dev/workos
    2. Check convex/auth.config.ts exists and exports providers array with two customJwt providers
    3. Check .env.local has all 6 WorkOS environment variables
  </verify>
  <done>
    WorkOS packages installed, auth.config.ts configured with JWT validation, environment variables scaffolded.
  </done>
</task>

<task type="auto">
  <name>Create middleware and auth routes</name>
  <files>middleware.ts, app/auth/callback/route.ts, app/auth/sign-in/route.ts, app/auth/sign-out/route.ts</files>
  <action>
    1. Create middleware.ts in project root:
       - Import authkitMiddleware from @workos-inc/authkit-nextjs
       - Configure middlewareAuth.enabled: true
       - Set unauthenticatedPaths: ['/', '/about', '/resume', '/projects', '/projects/*', '/stack', '/contact']
       - Export config.matcher: ['/((?!_next|api|favicon.ico).*)']
       - Reference: 04-RESEARCH.md "WorkOS AuthKit + Convex Integration Setup" section

    2. Create app/auth/callback/route.ts:
       - Import handleAuth from @workos-inc/authkit-nextjs
       - Export GET = handleAuth()

    3. Create app/auth/sign-in/route.ts:
       - Import getSignInUrl from @workos-inc/authkit-nextjs and redirect from next/navigation
       - Export async GET that gets sign-in URL and redirects

    4. Create app/auth/sign-out/route.ts:
       - Import getSignOutUrl from @workos-inc/authkit-nextjs and redirect from next/navigation
       - Export async GET that gets sign-out URL and redirects

    Pattern: All auth routes use WorkOS SDK helpers. No custom token handling.
  </action>
  <verify>
    1. Check middleware.ts exists and uses authkitMiddleware
    2. Check all three auth route files exist in app/auth/ directory
    3. Run: npm run build
    4. Verify no TypeScript errors related to auth imports
  </verify>
  <done>
    Middleware protects /admin/* routes. Auth routes handle OAuth callback, sign-in redirect, and sign-out.
  </done>
</task>

<task type="auto">
  <name>Update ConvexClientProvider with WorkOS auth integration</name>
  <files>app/ConvexClientProvider.tsx, app/layout.tsx</files>
  <action>
    1. Update app/ConvexClientProvider.tsx:
       - Keep existing 'use client' directive and imports
       - Import useAuth from @workos-inc/authkit-nextjs/use-auth
       - Import AuthKitProvider from @workos-inc/authkit-nextjs
       - Replace existing ConvexProvider with ConvexProviderWithAuth from convex/react
       - Wrap in AuthKitProvider -> ConvexProviderWithAuth structure
       - Pass useAuth hook to ConvexProviderWithAuth's useAuth prop
       - Reference: 04-RESEARCH.md "Convex client provider" example

    2. Verify app/layout.tsx already wraps children with ConvexClientProvider (should exist from Phase 1).

    Pattern: AuthKitProvider handles WorkOS session, ConvexProviderWithAuth bridges to Convex mutations.
  </action>
  <verify>
    1. Check app/ConvexClientProvider.tsx imports ConvexProviderWithAuth and useAuth from WorkOS
    2. Check AuthKitProvider wraps ConvexProviderWithAuth
    3. Run: npm run typecheck
    4. Verify no type errors in ConvexClientProvider
  </verify>
  <done>
    Convex client provider now includes WorkOS auth integration. All Convex mutations from client components will include auth token.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Set up WorkOS account and configure authentication</action>
  <instructions>
    WorkOS requires account creation and dashboard configuration that cannot be automated via CLI.

    Steps:
    1. Create WorkOS account at https://workos.com (if not already created)
    2. Create a new project in WorkOS dashboard
    3. Navigate to API Keys and copy:
       - Client ID (starts with "client_")
       - Secret Key (starts with "sk_")
    4. Generate cookie password locally: openssl rand -base64 32
    5. Update .env.local with real values (replace placeholders)
    6. Update ADMIN_EMAIL in .env.local with your admin email address
    7. Configure JWT custom claims template:
       - Go to Authentication -> Configure JWT Template
       - Add custom claim:
         ```
         "isAdmin": {% if user.email | lower in ["your@email.com"] %}true{% else %}false{% endif %}
         ```
       - Replace "your@email.com" with your actual admin email (lowercase)
    8. Restart dev server: npm run dev

    Why manual: WorkOS account creation, API key retrieval, and JWT template configuration require browser-based dashboard interaction.
  </instructions>
  <resume-signal>Type "configured" when WorkOS setup is complete and .env.local updated</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    WorkOS AuthKit integration with middleware route protection, OAuth callback handlers, and Convex auth provider.
  </what-built>
  <how-to-verify>
    Test authentication flow:

    1. Start dev server: npm run dev
    2. Visit http://localhost:3000/admin (should redirect to WorkOS sign-in)
    3. Sign in with your allowlisted email
    4. Verify redirect back to /admin (may show 404 - that's expected, admin pages come in later plans)
    5. Check browser dev tools -> Application -> Cookies for workos-session cookie (HTTP-only)
    6. Refresh page - session should persist (no redirect to sign-in)
    7. Visit http://localhost:3000/auth/sign-out
    8. Verify sign-out and redirect to home page
    9. Try visiting /admin again - should redirect to sign-in

    Expected behavior:
    - Only allowlisted email can access /admin/* routes
    - Session persists across refresh
    - Sign-out clears session

    If issues:
    - Check .env.local has correct WorkOS credentials
    - Verify JWT template in WorkOS dashboard includes isAdmin claim
    - Check browser console for auth errors
  </how-to-verify>
  <resume-signal>Type "approved" if auth flow works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. npm run build completes without errors
2. WorkOS session cookie appears after sign-in
3. Middleware redirects unauthenticated /admin/* requests to sign-in
4. Sign-out clears session and redirects to home
5. Only allowlisted email can successfully authenticate
</verification>

<success_criteria>
- AUTH-01: WorkOS AuthKit integrated ✓
- AUTH-02: Email allowlist configured via JWT custom claims ✓
- AUTH-03: Middleware protects all /admin/* routes ✓
- AUTH-04: Login redirects to /admin after successful auth ✓
- AUTH-05: Sign-out functionality available ✓
- AUTH-06: Session persists across browser refresh ✓
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication---admin-panel/04-01-SUMMARY.md` documenting:
- WorkOS packages installed and configured
- Auth routes created (callback, sign-in, sign-out)
- Middleware protecting /admin/* routes
- ConvexClientProvider updated with WorkOS auth integration
- Email allowlist configured via JWT custom claims
- Verification results from human testing
</output>
