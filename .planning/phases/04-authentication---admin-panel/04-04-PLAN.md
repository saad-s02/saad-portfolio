---
phase: 04-authentication---admin-panel
plan: 04
type: execute
wave: 2
depends_on: [04-02, 04-03]
files_modified:
  - app/admin/projects/page.tsx
  - app/admin/projects/new/page.tsx
  - app/admin/projects/new/schema.ts
  - app/admin/projects/new/actions.ts
  - app/admin/projects/new/ProjectForm.tsx
  - app/admin/projects/[id]/edit/page.tsx
  - app/admin/projects/[id]/edit/ProjectForm.tsx
  - components/admin/DeleteProjectButton.tsx
  - components/admin/ProjectStatusToggle.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can view all projects (published and draft) in list"
    - "Admin can create new project via form"
    - "Admin can edit existing project via form"
    - "Admin can delete project with confirmation dialog"
    - "Admin can toggle draft/published status"
    - "Admin can toggle featured flag"
    - "Form validates input and shows error messages"
  artifacts:
    - path: "app/admin/projects/page.tsx"
      provides: "Projects list with all statuses"
      min_lines: 60
    - path: "app/admin/projects/new/page.tsx"
      provides: "Create project page"
      min_lines: 15
    - path: "app/admin/projects/new/ProjectForm.tsx"
      provides: "Create project form with validation"
      min_lines: 200
    - path: "app/admin/projects/new/schema.ts"
      provides: "Zod schema for project validation"
      exports: ["projectSchema", "ProjectFormData"]
    - path: "app/admin/projects/new/actions.ts"
      provides: "Server Action for creating project"
      exports: ["createProjectAction"]
    - path: "app/admin/projects/[id]/edit/page.tsx"
      provides: "Edit project page"
      min_lines: 30
    - path: "app/admin/projects/[id]/edit/ProjectForm.tsx"
      provides: "Edit project form pre-populated with data"
      min_lines: 200
    - path: "components/admin/DeleteProjectButton.tsx"
      provides: "Delete confirmation dialog component"
      min_lines: 50
    - path: "components/admin/ProjectStatusToggle.tsx"
      provides: "Status toggle with optimistic UI"
      min_lines: 40
  key_links:
    - from: "app/admin/projects/new/ProjectForm.tsx"
      to: "react-hook-form"
      via: "useForm hook with zodResolver"
      pattern: "useForm.*zodResolver"
    - from: "app/admin/projects/new/actions.ts"
      to: "convex/projects.ts"
      via: "fetchMutation to create mutation"
      pattern: "fetchMutation.*api\\.projects\\.create"
    - from: "components/admin/ProjectStatusToggle.tsx"
      to: "convex/projects.ts"
      via: "useMutation to updateStatus"
      pattern: "useMutation.*api\\.projects\\.updateStatus"
---

<objective>
Build complete admin interface for managing projects (list, create, edit, delete, toggle status/featured).

Purpose: Enable admin to manage portfolio projects through web forms with validation, optimistic UI updates for toggles, and confirmation dialogs for destructive actions.

Output: Full CRUD interface for projects with react-hook-form validation, Server Actions for mutations, and real-time Convex reactivity.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-authentication---admin-panel/04-RESEARCH.md

# Dependencies
@.planning/phases/04-authentication---admin-panel/04-02-PLAN.md
@.planning/phases/04-authentication---admin-panel/04-03-PLAN.md

# Schema and existing patterns
@convex/schema.ts
@convex/projects.ts
@components/contact/ContactForm.tsx
@lib/validations/contact.ts
</context>

<tasks>

<task type="auto">
  <name>Create projects list page</name>
  <files>app/admin/projects/page.tsx</files>
  <action>
    Create app/admin/projects/page.tsx:

    1. Mark as 'use client' (uses Convex hooks and client interactivity)
    2. Import useQuery, useMutation from convex/react, api from @/convex/_generated/api
    3. Import Link from next/link, useRouter from next/navigation
    4. Import ProjectStatusToggle, DeleteProjectButton components (created in next task)

    5. Create ProjectsListPage component:
       - Fetch all projects: const projects = useQuery(api.projects.listAll)
       - Handle loading state
       - Render:
         * Page heading "Projects" with "Create New Project" button (links to /admin/projects/new)
         * Projects table or grid:
           - Each row/card shows: title, slug, status badge, featured badge
           - Actions: Edit button (links to /admin/projects/[id]/edit), Status toggle, Featured toggle, Delete button
         * Empty state if no projects

    6. Use table layout for desktop, responsive cards for mobile
    7. Status badge: green for published, yellow for draft
    8. Featured badge: star icon if featured=true

    Pattern: Client Component with useQuery for real-time project list.
  </action>
  <verify>
    1. Check app/admin/projects/page.tsx exists and is Client Component
    2. Check useQuery(api.projects.listAll) fetches all projects
    3. Check "Create New Project" button links to /admin/projects/new
    4. Check Edit button links to /admin/projects/[id]/edit
    5. Run: npm run typecheck
  </verify>
  <done>
    Projects list page displays all projects with status badges, featured indicators, and action buttons.
  </done>
</task>

<task type="auto">
  <name>Create project form validation schema and Server Action</name>
  <files>app/admin/projects/new/schema.ts, app/admin/projects/new/actions.ts</files>
  <action>
    1. Create app/admin/projects/new/schema.ts:
       - Import z from zod
       - Export projectSchema with fields matching convex/schema.ts projects table:
         * title: z.string().min(1, "Title required").max(200)
         * slug: z.string().min(1).regex(/^[a-z0-9-]+$/, "Slug must be lowercase, numbers, hyphens only")
         * summary: z.string().min(1, "Summary required").max(500)
         * content: z.string().min(1, "Content required")
         * status: z.enum(["draft", "published"])
         * featured: z.boolean()
         * stack: z.array(z.string()).min(1, "At least one tech required")
         * tags: z.array(z.string())
         * links: z.array(z.object({ label: z.string().min(1), url: z.string().url() }))
         * screenshots: z.array(z.string().url())
       - Export type ProjectFormData = z.infer<typeof projectSchema>

    2. Create app/admin/projects/new/actions.ts:
       - Mark 'use server'
       - Import projectSchema, ProjectFormData
       - Import api from @/convex/_generated/api, fetchMutation from convex/nextjs
       - Import withAuth from @workos-inc/authkit-nextjs

       - Export async createProjectAction(formData: ProjectFormData):
         * Verify auth: const { user } = await withAuth(); if (!user) throw Error("Unauthorized")
         * Validate with Zod: const validated = projectSchema.parse(formData)
         * Call Convex mutation: const projectId = await fetchMutation(api.projects.create, validated)
         * Return { success: true, projectId }

    Reference: 04-RESEARCH.md "Admin Form with react-hook-form + Zod + Server Actions" and contact form pattern.
  </action>
  <verify>
    1. Check app/admin/projects/new/schema.ts exports projectSchema and ProjectFormData type
    2. Check app/admin/projects/new/actions.ts exports createProjectAction
    3. Check Server Action verifies auth and validates input
    4. Run: npm run typecheck
  </verify>
  <done>
    Project validation schema and Server Action created for form submissions.
  </done>
</task>

<task type="auto">
  <name>Create project form component and page</name>
  <files>app/admin/projects/new/ProjectForm.tsx, app/admin/projects/new/page.tsx</files>
  <action>
    1. Create app/admin/projects/new/ProjectForm.tsx:
       - Mark 'use client'
       - Import useForm, useFieldArray from react-hook-form
       - Import zodResolver from @hookform/resolvers/zod
       - Import projectSchema, ProjectFormData from ./schema
       - Import createProjectAction from ./actions
       - Import useRouter from next/navigation, toast from react-hot-toast

       - Create ProjectForm component:
         * Initialize form with useForm, zodResolver, default values (status: "draft", featured: false, empty arrays)
         * Use useFieldArray for links array
         * On submit: call createProjectAction, show toast, redirect to /admin/projects
         * Render form fields:
           - Title (input)
           - Slug (input with helper text about URL format)
           - Summary (textarea, 3 rows)
           - Content (textarea, 12 rows, font-mono)
           - Status (select: draft/published)
           - Featured (checkbox)
           - Stack (textarea with comma-separated helper text, parse into array on submit)
           - Tags (textarea with comma-separated helper text, parse into array on submit)
           - Links (dynamic array with Add/Remove buttons)
           - Screenshots (textarea with one URL per line, parse into array on submit)
         * Show validation errors below each field
         * Submit button disabled while submitting
         * Cancel button (router.back())

    2. Create app/admin/projects/new/page.tsx:
       - Import ProjectForm
       - Render heading "Create New Project" and ProjectForm component

    Reference: 04-RESEARCH.md form example and existing ContactForm.tsx pattern.
    Pattern: Client Component form with react-hook-form + Zod + Server Actions.
  </action>
  <verify>
    1. Check app/admin/projects/new/ProjectForm.tsx exists and uses react-hook-form
    2. Check form has all fields matching schema
    3. Check form validates with Zod schema
    4. Check form submits via Server Action
    5. Check app/admin/projects/new/page.tsx renders ProjectForm
    6. Run: npm run build
  </verify>
  <done>
    Create project form with validation, error display, and Server Action submission.
  </done>
</task>

<task type="auto">
  <name>Create edit project page and form</name>
  <files>app/admin/projects/[id]/edit/page.tsx, app/admin/projects/[id]/edit/ProjectForm.tsx, app/admin/projects/[id]/edit/actions.ts</files>
  <action>
    1. Create app/admin/projects/[id]/edit/actions.ts:
       - Mark 'use server'
       - Import projectSchema from ../../new/schema
       - Import api, fetchMutation, withAuth
       - Export async updateProjectAction(id: string, formData: ProjectFormData):
         * Verify auth
         * Validate with projectSchema.parse(formData)
         * Call fetchMutation(api.projects.update, { id, ...validated })
         * Return { success: true }

    2. Create app/admin/projects/[id]/edit/ProjectForm.tsx:
       - Similar structure to new/ProjectForm.tsx
       - Accept initialData prop (project to edit)
       - Pre-populate form with initialData using defaultValues
       - Call updateProjectAction instead of createProjectAction
       - Redirect to /admin/projects on success

    3. Create app/admin/projects/[id]/edit/page.tsx:
       - Mark 'use client'
       - Import useQuery from convex/react
       - Get id from params
       - Fetch project: useQuery(api.projects.listAll) and find by id
       - Handle loading state
       - Render heading "Edit Project" and ProjectForm with initialData

    Pattern: Reuse validation schema, similar form structure with pre-population.
  </action>
  <verify>
    1. Check edit/actions.ts exports updateProjectAction
    2. Check edit/ProjectForm.tsx accepts initialData prop
    3. Check edit/page.tsx fetches project and passes to form
    4. Run: npm run typecheck
  </verify>
  <done>
    Edit project page with form pre-populated with existing project data.
  </done>
</task>

<task type="auto">
  <name>Create project status toggle and delete components</name>
  <files>components/admin/ProjectStatusToggle.tsx, components/admin/DeleteProjectButton.tsx</files>
  <action>
    1. Create components/admin/ProjectStatusToggle.tsx:
       - Mark 'use client'
       - Import useMutation from convex/react, api, useState, toast
       - Accept props: projectId, initialStatus
       - Use useState for optimisticStatus (initialized with initialStatus)
       - Use useMutation for api.projects.updateStatus
       - On toggle:
         * Calculate new status (draft -> published, published -> draft)
         * Update optimisticStatus immediately
         * Call mutation
         * Show toast on success
         * Rollback optimisticStatus on error
       - Render button showing current status with toggle icon

    2. Create components/admin/DeleteProjectButton.tsx:
       - Mark 'use client'
       - Import useMutation, api, useState, toast, useRouter
       - Accept props: projectId, projectTitle
       - Use useState for showConfirm modal
       - Use useMutation for api.projects.remove
       - Render delete button (text-red-500)
       - On click: show confirmation modal
       - Modal content: "Delete {projectTitle}? This cannot be undone."
       - Modal actions: Cancel button, Delete button (red, calls mutation)
       - On successful delete: toast + router.push('/admin/projects')

    Reference: 04-RESEARCH.md "Optimistic UI Updates" and "Delete Confirmation Dialog".
  </action>
  <verify>
    1. Check components/admin/ProjectStatusToggle.tsx exists with optimistic updates
    2. Check components/admin/DeleteProjectButton.tsx exists with confirmation modal
    3. Check both components use useMutation hooks
    4. Run: npm run typecheck
  </verify>
  <done>
    Status toggle with optimistic UI and delete button with confirmation dialog.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete admin interface for managing projects: list view, create form, edit form, status toggles, delete with confirmation.
  </what-built>
  <how-to-verify>
    Test projects admin interface:

    1. Visit http://localhost:3000/admin/projects
    2. Verify projects list shows all projects (or empty state if none)

    3. Test CREATE:
       - Click "Create New Project"
       - Fill form with test data:
         * Title: "Test Project"
         * Slug: "test-project"
         * Summary: "A test project"
         * Content: "## Problem\nTest content"
         * Status: Draft
         * Featured: unchecked
         * Stack: "Next.js, TypeScript" (comma-separated)
       - Submit form
       - Verify redirect to projects list
       - Verify new project appears in list

    4. Test STATUS TOGGLE:
       - Click status toggle on test project
       - Verify status changes immediately (optimistic)
       - Verify change persists on page refresh

    5. Test FEATURED TOGGLE:
       - Click featured toggle (if component added to list)
       - Verify featured badge appears/disappears

    6. Test EDIT:
       - Click "Edit" on test project
       - Verify form pre-populated with project data
       - Change title to "Updated Test Project"
       - Submit form
       - Verify redirect to projects list
       - Verify title updated

    7. Test DELETE:
       - Click "Delete" on test project
       - Verify confirmation modal appears with project title
       - Click "Cancel" - modal closes, project still exists
       - Click "Delete" again, then "Delete" in modal
       - Verify project removed from list
       - Verify redirect to projects list

    8. Test VALIDATION:
       - Try creating project with empty title - should show error
       - Try invalid slug (with spaces) - should show error
       - Try empty stack array - should show error

    Expected behavior:
    - All CRUD operations work correctly
    - Forms validate input and show errors
    - Status/featured toggles update immediately
    - Delete requires confirmation
    - Changes persist to Convex database

    If issues:
    - Check browser console for errors
    - Verify Convex backend running
    - Check Server Actions authentication
  </how-to-verify>
  <resume-signal>Type "approved" if projects admin works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Projects list displays all projects with status and featured indicators
2. Create form validates input and creates projects
3. Edit form pre-populates and updates projects
4. Status toggle works with optimistic UI
5. Delete requires confirmation and removes project
6. All forms show validation errors
7. All mutations succeed with authenticated session
</verification>

<success_criteria>
- ADMIN-02: Projects list shows all projects (published and draft) ✓
- ADMIN-03: Create new project form with all required fields ✓
- ADMIN-04: Edit existing project form pre-populated with current data ✓
- ADMIN-05: Delete project with confirmation dialog ✓
- ADMIN-06: Toggle draft/published status for projects ✓
- ADMIN-07: Toggle featured flag for projects ✓
- Forms use react-hook-form + Zod for type-safe validation
- Server Actions call authenticated Convex mutations
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication---admin-panel/04-04-SUMMARY.md` documenting:
- Projects list page with all projects display
- Create project form with validation
- Edit project form with pre-population
- Status toggle with optimistic UI
- Featured toggle functionality
- Delete button with confirmation dialog
- Verification results from human testing
- Screenshots or notes on UX flow
</output>
